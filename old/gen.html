<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        
        <title>v0</title>

        <!-- https://threejs.org/examples/webgl_postprocessing_unreal_bloom.html -->
        
        <!-- Scripts -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
        
        
        
        
        <script src="../three.min.js"></script>
        
        <script src="https://threejs.org/examples/js/postprocessing/EffectComposer.js"></script>
        <script src="https://threejs.org/examples/js/postprocessing/RenderPass.js"></script>
        <script src="https://threejs.org/examples/js/postprocessing/ShaderPass.js"></script>
        <script src="https://threejs.org/examples/js/shaders/CopyShader.js"></script>
        <script src="https://threejs.org/examples/js/shaders/LuminosityHighPassShader.js"></script>
        <script src="https://threejs.org/examples/js/postprocessing/UnrealBloomPass.js"></script>
        
        <script src="https://rawgithub.com/jwagner/simplex-noise.js/master/simplex-noise.js"></script>
        
        <style>
            body{
                margin: 0;
                overflow: hidden;
            }
        </style>
    </head>
    
    <body>
        
        <script>
            var dim = 120; // Make divisible by three?
            var matrixX = dim, matrixY = dim;
            
            var noiseDensity = 0.008;
            
            var t = 0;
            var tx = 0, ty = 0, tz = 0;
            
            var simplexX, simplexY, simplexZ;
            var scene, camera, renderer;
            
            var params = {
				exposure: 1.2,
				bloomStrength: 1.1,
				bloomThreshold: 0,
				bloomRadius: 0.3
			};
            
            function initNoise(){
                // Seed the simplex noise generators
                simplexX = new SimplexNoise();
                simplexY = new SimplexNoise();
                simplexZ = new SimplexNoise();
            }
            
            function initialize(){
                initNoise();

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer();
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);
            }
            
            function initVertices(){                
                for(var x = 0; x < matrixX; x++){
                    for(var y = 0; y < matrixY; y++){
                        for(var z = 0; z < 3; z++){
                            vertArray.push(0);
                            colors.push(1, 1, 1);
                        }                        
                    }
                }                
            }
            
            function updateVerts(){
                var positions = mesh.geometry.attributes.position.array;
                var colors = mesh.geometry.attributes.color;
                
                for(var x = 0; x < matrixX; x++){
                    for(var y = 0; y < matrixY; y++){
                        var posX = simplexX.noise2D(x * noiseDensity + tx, y * noiseDensity + tx);
                        var posY = simplexY.noise2D(x * noiseDensity + ty, y * noiseDensity + ty);
                        var posZ = simplexZ.noise2D(x * noiseDensity + tz, y * noiseDensity + tz);
                        
                        positions[(x + y * matrixX) * 3 + 0] = posX;
                        positions[(x + y * matrixY) * 3 + 1] = posY;
                        positions[(x + y * matrixX) * 3 + 2] = posZ;
                        
                        colors.setXYZ(
                            x + y * matrixX,
                            simplexX.noise3D(x * noiseDensity, y * noiseDensity, t) * 0.5 + 0.5,
                            simplexY.noise3D(x * noiseDensity, y * noiseDensity, t) * 0.1 + 0.1,
                            simplexZ.noise3D(x * noiseDensity, y * noiseDensity, t) * 0.5 + 0.5
                        );
                    }                    
                }
                t+=0.002;
                tx+=0.001;
                ty += 0.002;
                tz += 0.003;
                
                mesh.geometry.attributes.position.needsUpdate = true;
                mesh.geometry.attributes.color.needsUpdate = true;
            }
            
            var vertArray = [];
            var colors = [];
            
            initialize();
            
            initVertices();
            
            var vertices = new Float32Array(vertArray);
            
            var geometry = new THREE.BufferGeometry();
            geometry.addAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.addAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.dynamic = true;
            
            var material = new THREE.MeshBasicMaterial({color: 0xffffff, vertexColors: THREE.VertexColors, wireframe: true});
            
            var mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            
            camera.position.z = 2;
            
            var renderScene = new THREE.RenderPass(scene, camera);
            
            var bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.5, 0.4, 0.85);
            bloomPass.threshold = params.bloomThreshold;
            bloomPass.strength = params.bloomStrength;
            bloomPass.radius = params.bloomRadius;
            
            composer = new THREE.EffectComposer( renderer );
			composer.setSize( window.innerWidth, window.innerHeight );
			composer.addPass( renderScene );
			composer.addPass( bloomPass );
            
            function animate(){
                requestAnimationFrame(animate);
                
                updateVerts();
                
                
                
                composer.render(scene, camera);
            }
            
            animate();
            
        </script>
        
    </body>
</html>